---
title: "swd_long"
author: "Michael Škvrňák"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(lme4)
library(targets)
library(ggplot2)

tar_load(cz_2023_long)
# cz_2023_long <- readRDS("output/cz_2023_long.rds")

long_w1_w5 <- cz_2023_long
long_w1_w4 <- cz_2023_long %>% 
    filter(wave != 5)
```

```{r}
ggplot(long_w1_w5, aes(x = SWD_num)) + 
    geom_histogram(bins = 11) + 
    facet_wrap(~wave) + 
    theme_minimal() + 
    labs(title = "Distribution of SWD by waves", 
         x = "SWD")
```

## Klasifikace voličů podle stability hlasování a hlasování pro vítěze
- stable winner = hlasoval pro Petra Pavla v obou kolech
- unstable winner = ve 2. kole hlasoval pro Petra Pavla (v 1. pro kohokoliv jiného)
- stable loser = hlasoval pro Andreje Babiše v obou kolech
- unstable loser = ve 2. kole hlasoval pro Andreje Babiše
- stable non-voter = v obou kolech se neúčastnil
- unstable non-voter = v 2. kole nehlasoval, v 1. hlasoval

# Vlny 1-4
```{r}
rename_map <- c(
    "winnerwinner" = "winner", 
    "winnerloser" = "loser", 
    "winner_stableunstable loser" = "unstable loser",
    "winner_stableunstable non-voter" = "unstable non-voter",
    "winner_stablestable loser" = "stable loser",
    "winner_stablestable non-voter" = "stable non-voter",
    "winner_stablestable winner" = "stable winner",
    "winner_stableunstable winner" = "unstable winner", 
    "vote_gov" = "government voter (PS 2021)"
)

m1_w4 <- lmer(SWD_num ~ winner * wave + (1 | RADIOMETER_ID2), 
     data = long_w1_w4) 

m2_w4 <- lmer(SWD_num ~ winner_stable * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w4) 
m2_w4b <- lmer(SWD_num ~ winner_stable2 * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w4) 

m3_w4 <- lmer(SWD_num ~ vote_gov * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w4) 

modelsummary::modelsummary(list(m1_w4, m2_w4, m2_w4b, m3_w4), 
                           stars = TRUE, 
                           coef_rename = rename_map
                           )

ggeffects::ggeffect(m1_w4, c("wave", "winner")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
ggeffects::ggeffect(m2_w4, c("wave", "winner_stable")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
ggeffects::ggeffect(m2_w4b, c("wave", "winner_stable2")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
ggeffects::ggeffect(m3_w4, c("wave", "vote_gov")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
```

# Vlny 1-5
```{r}
m1_w5 <- lmer(SWD_num ~ winner * wave + (1 | RADIOMETER_ID2), 
     data = long_w1_w5) 

m2_w5 <- lmer(SWD_num ~ winner_stable * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w5) 

m2_w5b <- lmer(SWD_num ~ winner_stable2 * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w5) 

m3_w5 <- lmer(SWD_num ~ vote_gov * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w5) 

modelsummary::modelsummary(list(m1_w5, m2_w5, m2_w5b, m3_w5), 
                           stars = TRUE, 
                           coef_rename = rename_map)

ggeffects::ggeffect(m1_w5, c("wave", "winner")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD",
         colour = "Voter type")
ggeffects::ggeffect(m2_w5, c("wave", "winner_stable")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
ggeffects::ggeffect(m2_w5b, c("wave", "winner_stable2")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
ggeffects::ggeffect(m3_w5, c("wave", "vote_gov")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
```
