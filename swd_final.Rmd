---
title: "Satisfaction with democracy"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: readable
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(lme4)
library(boot)
library(dplyr)
library(sjPlot)
library(targets)
library(ggplot2)
library(ggeffects)
library(modelsummary)

options("modelsummary_format_numeric_latex" = "plain")

tar_load(cz_2023_models)
tar_load(all_panels)
```


## Table 1: Descriptive stats of SWD
```{r, message=FALSE}
cz_2023 <- cz_2023_models

mean_swd <- function(data, indices){
    dt <- data[indices, ]
    c(
        mean(dt$SWD_w1, na.rm = TRUE), 
        mean(dt$SWD_w2, na.rm = TRUE), 
        mean(dt$SWD_w3, na.rm = TRUE), 
        mean(dt$SWD_w4, na.rm = TRUE), 
        mean(dt$SWD_w5, na.rm = TRUE)
    )
}

set.seed(1234)
boot_swd <- boot(data = cz_2023, mean_swd, R = 1000)
boot_ci_w1 <- boot.ci(boot_swd, type = "norm", index = 1)
boot_ci_w2 <- boot.ci(boot_swd, type = "norm", index = 2)
boot_ci_w3 <- boot.ci(boot_swd, type = "norm", index = 3)
boot_ci_w4 <- boot.ci(boot_swd, type = "norm", index = 4)
boot_ci_w5 <- boot.ci(boot_swd, type = "norm", index = 5)

boot_to_df <- function(boot_ci){
  data.frame(
    mean = boot_ci$t0, 
    lower = boot_ci$normal[, 2], 
    upper = boot_ci$normal[, 3]
  )
}

waves <- tribble(
    ~wave, ~start_date, ~end_date,
    "Wave 1", "2022-11-25", "2022-12-06",
    "Wave 2", "2023-01-09", "2023-01-13",
    "Wave 3", "2023-01-16", "2023-01-22", 
    "Wave 4", "2023-01-30", "2023-02-06", 
    "Wave 5", "2023-06-19", "2023-07-03"
) %>% 
    mutate(across(ends_with("date"), as.Date), 
           mid_date = start_date + ((end_date - start_date) / 2)) %>% 
    mutate(wave_label = case_when(
      wave == "Wave 1" ~ "Wave 1 (25.11.–6.12.)", 
      wave == "Wave 2" ~ "Wave 2 (9.–13.1.)",
      wave == "Wave 3" ~ "Wave 3 (16.–22.1.)", 
      wave == "Wave 4" ~ "Wave 4 (30.1.–6.2.)",
      wave == "Wave 5" ~ "Wave 5 (19.6.–3.7.)"
    ))

elections <- tribble(
    ~round, ~start_date, ~end_date, 
    "Round 1", "2023-01-13", "2023-01-14",
    "Round 2", "2023-01-27", "2023-01-28"
) %>% 
    mutate(across(ends_with("date"), as.Date))

boot_swd_w1_5 <- purrr::map_df(
  list(boot_ci_w1, boot_ci_w2, boot_ci_w3, 
       boot_ci_w4, boot_ci_w5), 
           boot_to_df) %>% 
  mutate(wave = paste("Wave ", row_number(), sep = "")) %>% 
  left_join(., waves %>% select(wave, mid_date, wave_label), by = "wave")
```


```{r}
Y_MIN <- 2.5
Y_MAX <- 7.5
ggplot(waves) + 
    geom_rect(aes(xmin = start_date, xmax = end_date, 
                  ymin = Y_MIN, ymax = Y_MAX), 
              fill = "gray60", alpha = 0.5
              ) + 
  geom_rect(data = elections, aes(
    xmin = start_date, xmax = end_date, 
    ymin = Y_MIN, ymax = Y_MAX), 
    fill = "black") + 
  geom_text(x = as.Date("2023-01-14"), y = Y_MIN, 
            label = "Round 1", 
            colour = "black", angle = 90, 
            hjust = -0.1, vjust = 1.1) + 
  geom_text(x = as.Date("2023-01-28"), y = Y_MIN, 
            label = "Round 2", 
            colour = "black", angle = 90, 
            hjust = -0.1, vjust = 1.1) + 
  geom_text(aes(x = mid_date, label = wave_label), 
            y = Y_MAX, angle = 90, hjust = 1.05) + 
  geom_pointrange(data = boot_swd_w1_5,
                  aes(x = mid_date, y = mean, ymax = upper,
                      ymin = lower), shape = 3) +
  theme_minimal() + 
  scale_y_continuous(limits = c(Y_MIN, Y_MAX)) + 
  guides(alpha = "none") + 
  scale_x_date(date_labels = "%b %Y", date_breaks = "month") + 
  labs(x = "", # title = "2023 Czech presidential election panel", 
       y = "Average SWD (0–10 scale)", 
       # caption = "Note: Black points depict average SWD within the wave (all respondents participating in a given wave included)\nwith bootstrapped 95% confidence intervals. Grey rectangles show the dates of data collection, red lines indicate election days."
       ) 
ggsave("output/wave_swd.png", width = 8, 
       height = 4)
```

```{r}
avg_swd_cz2023 <- cz_2023 %>% 
  # filter(w1 == 1 & w2 == 1 & w3 == 1 & w4 == 1 & w5 == 1) %>% 
  mutate(across(matches("SWD_w[0-9]+"), 
                function(x) x / 10)) %>% 
  summarise(across(matches("SWD_w[0-9]+"), ~round(mean(.x, na.rm = TRUE), 2)))

# avg_swd_cz2023 %>% 
#     knitr::kable(., format = "latex") %>% 
#     writeLines(., "output/avg_swd_cz2023_panel.tex")

avg_swd_cz2023 %>% 
    knitr::kable()
```
```{r}
mean_swd_pre_post <- function(data, indices){
    dt <- data[indices, ]
    boot_swd_pre <- mean(dt$swd_pre, na.rm = TRUE) 
    boot_swd_post <- mean(dt$swd_post, na.rm = TRUE)
    c(
        boot_swd_pre, 
        boot_swd_post, 
        boot_swd_post - boot_swd_pre
    )
}

boot_ci_swd <- function(boot_out){
  ci_pre <- boot_to_df(boot.ci(boot_out, type = "norm", index = 1)) %>% 
    rename_with(., ~paste0("swd_pre_", .x))
  ci_post <- boot_to_df(boot.ci(boot_out, type = "norm", index = 2)) %>% 
    rename_with(., ~paste0("swd_post_", .x))
  ci_diff <- boot_to_df(boot.ci(boot_out, type = "norm", index = 3)) %>% 
    rename_with(., ~paste0("swd_diff_", .x))
  
  bind_cols(
    ci_pre, ci_post, ci_diff
  )
}


cz_2023_avg <- all_panels %>% 
    filter(election == "CZ 2023") %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post))
cz_1996_avg <- all_panels %>% 
    filter(election == "CZ 1996") %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post))
de_2017_avg <- all_panels %>% 
  filter(election == "DE (Ost) 2017") %>% 
  filter(!is.na(swd_pre) & !is.na(swd_post))
hu_2019_avg <- all_panels %>% 
  filter(election == "HU 2019") %>% 
  filter(!is.na(swd_pre) & !is.na(swd_post))
pl_2019_avg <- all_panels %>% 
  filter(election == "PL 2019") %>% 
  filter(!is.na(swd_pre) & !is.na(swd_post))
ro_2009_avg <- all_panels %>% 
  filter(election == "RO 2009") %>% 
  filter(!is.na(swd_pre) & !is.na(swd_post))
ro_2012_avg <- all_panels %>% 
  filter(election == "RO 2012") %>% 
  filter(!is.na(swd_pre) & !is.na(swd_post))

set.seed(1234)
boot_cz_1996 <- boot_ci_swd(boot(cz_1996_avg, mean_swd_pre_post, R = 1000))
boot_cz_2023 <- boot_ci_swd(boot(cz_2023_avg, mean_swd_pre_post, R = 1000))
boot_de_2017 <- boot_ci_swd(boot(de_2017_avg, mean_swd_pre_post, R = 1000))
boot_hu_2019 <- boot_ci_swd(boot(hu_2019_avg, mean_swd_pre_post, R = 1000))
boot_pl_2019 <- boot_ci_swd(boot(pl_2019_avg, mean_swd_pre_post, R = 1000))
boot_ro_2009 <- boot_ci_swd(boot(ro_2009_avg, mean_swd_pre_post, R = 1000))
boot_ro_2012 <- boot_ci_swd(boot(ro_2012_avg, mean_swd_pre_post, R = 1000))

bootstrap_out <- purrr::map2_df(
  c("CZ 1996", "CZ 2023", "DE 2017", 
    "HU 2019", "PL 2019", "RO 2009", 
    "RO 2012"), 
  list(
    boot_cz_1996, boot_cz_2023, boot_de_2017, 
    boot_hu_2019, boot_pl_2019, boot_ro_2009, 
    boot_ro_2012
  ), function(x, y) {
    y %>% mutate(election = x)
  }
)

f2d <- function(x) format(x, nsmall = 2, trim = TRUE)

n <- all_panels %>% 
    group_by(election) %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post)) %>% 
    summarise(n = n()) %>% 
    mutate(election = if_else(election == "DE (Ost) 2017", 
                              "DE 2017", election))

avg_swd_all_panels <- bootstrap_out %>% 
  mutate(
    country = case_when(
      grepl("CZ", election) ~ "Czech Republic", 
      grepl("DE", election) ~ "Germany (East)",
      grepl("PL", election) ~ "Poland", 
      grepl("HU", election) ~ "Hungary", 
      grepl("RO", election) ~ "Romania"
    ), 
    year = stringr::str_extract(election, "[0-9]{4}"), 
    election_type = case_when(
      election %in% c("CZ 2023", "RO 2009") ~ "presidential", 
      election %in% c("PL 2019", "HU 2019") ~ "EP election", 
      TRUE ~ "parliamentary"
    )) %>% 
  select(election, country, year, election_type, matches("swd_")) %>% 
  mutate(across(matches("swd_"), ~round(.x, 2))) %>% 
  mutate(swd_pre = paste0(f2d(swd_pre_mean), " (", f2d(swd_pre_lower), 
                          " – ", f2d(swd_pre_upper), ")"), 
         swd_post = paste0(f2d(swd_post_mean), " (", f2d(swd_post_lower), 
                           " – ", f2d(swd_post_upper), ")"), 
         swd_diff = paste0(f2d(swd_diff_mean), " (", f2d(swd_diff_lower), " – ", 
                           f2d(swd_diff_upper), ")")
         ) %>% 
  left_join(., n, by = "election") %>% 
  select(country, year, election_type, swd_pre, swd_post, swd_diff, n) 

avg_swd_all_panels %>% 
    knitr::kable(., format = "latex", col.names = c(
      "Country", "Year", "Type of election", "Pre-election SWD",
      "Post-election SWD", "SWD difference", "N"
    )) %>% 
    writeLines(., "output/tab1.tex")

avg_swd_all_panels %>% 
    knitr::kable(col.names = c(
      "Country", "Year", "Type of election", "Pre-election SWD",
      "Post-election SWD", "SWD difference", "N"
    ))
```


## Table 2: Turnout and satisfaction with democracy, 2023 Czech presidential election
```{r}
cz_2023_all_waves_resp <- cz_2023 %>% 
    filter(w1 == 1 & w2 == 1 & w3 == 1 & w4 == 1) %>% 
    mutate(age = (age - 18) / 10) %>% 
    rename(pol_knowledge = pol_knowledge_pct) %>% 
    mutate(prez_vote_type = case_when(
      PRES2023CAND1r_w3 == "nevolič" & 
        PRES2023CAND2r_w4 == "nevolič" ~ "abstainer",
      PRES2023CAND1r_w3 == "Petr Pavel" & 
        PRES2023CAND2r_w4 == "Petr Pavel" ~ "full winner",
      PRES2023CAND1r_w3 == "Andrej Babiš" & 
        PRES2023CAND2r_w4 == "Andrej Babiš" ~ "full loser",
      PRES2023CAND2r_w4 == "Petr Pavel" ~ "partial winner",
      PRES2023CAND2r_w4 == "Andrej Babiš" ~ "partial loser",
      TRUE ~ "abstainer"
    )) %>% 
    mutate(prez_vote_type = factor(
      prez_vote_type, 
      levels = c("abstainer", 
                 "full winner", 
                 "partial winner", 
                 "full loser", 
                 "partial loser"))) %>% 
  mutate(across(c("swd_pre", "swd_post", "pol_interest_num"), 
                normalize_scale), 
         swd_diff = swd_post - swd_pre)

# haven::write_sav(cz_2023_all_waves_resp, "tmp/cz_2023_vsechny_vlny.sav")

ce1_round1 <- glm(voted_1r ~ SWD_w1 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_round1 <- glm(voted_1r ~ SWD_w1 + female + age + 
                    postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce3_round1 <- glm(voted_1r ~ SWD_w4 + female + age + 
                    postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_round1 <- glm(voted_1r ~ SWD_w1 + SWD_w4 + 
             female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)

ce1_round2 <- glm(voted_2r ~ SWD_w1 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_round2 <- glm(voted_2r ~ SWD_w1 + female + 
                    age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce3_round2 <- glm(voted_2r ~ SWD_w4 + female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + 
               pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_round2 <- glm(voted_2r ~ SWD_w1 + SWD_w4 + 
             female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)


# r2(ce1_round1, cz_2023_all_waves_resp)
# 
# pr2 <- tribble(~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6, ~m7, ~m8, 
#                "PseudoR2 (McFadden)", 
#                r2(ce1_round1), r2(ce2_round1), 
#                r2(ce3_round1), r2(ce4_round1), 
#                r2(ce1_round2), r2(ce2_round2), 
#                r2(ce3_round2), r2(ce4_round2))
# 
# model_n_vars <- broom::tidy(ce4_round1) %>% 
#     filter(!grepl("election", term)) %>% 
#     nrow()
# 
# attr(pr2, "position") <- (model_n_vars * 2) + 2
# 
# pr2a <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
#                "PseudoR2 (McFadden)", 
#                r2(ce1_round1), r2(ce2_round1), 
#                r2(ce3_round1), r2(ce4_round1))

# model_n_vars <- broom::tidy(ce4_round1) %>% 
#     filter(!grepl("election", term)) %>% 
#     nrow()
# 
# attr(pr2a, "position") <- (model_n_vars * 2) + 2
# 
# pr2b <- tribble(~term, ~m5, ~m6, ~m7, ~m8, 
#                "PseudoR2 (McFadden)", 
#                r2(ce1_round2), r2(ce2_round2), 
#                r2(ce3_round2), r2(ce4_round2))
# 
# model_n_vars <- broom::tidy(ce4_round1) %>% 
#     filter(!grepl("election", term)) %>% 
#     nrow()
# 
# attr(pr2b, "position") <- (model_n_vars * 2) + 2


modelsummary(list("Round 1" = ce1_round1, "Round 1" = ce2_round1, 
                  "Round 1" = ce3_round1, "Round 1" = ce4_round1, 
                  "Round 2" = ce1_round2, "Round 2" = ce2_round2, 
                  "Round 2" = ce3_round2, "Round 2" = ce4_round2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             # add_rows = pr2,
             notes = c("Data weighted by turnout."),
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election",
             output = "output/tab2_models.tex")

modelsummary(list("Round 1" = ce1_round1, "Round 1" = ce2_round1, 
                  "Round 1" = ce3_round1, "Round 1" = ce4_round1), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             # add_rows = pr2a,
             notes = c("Data weighted by turnout."),
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election",
             output = "output/tab2_models_part1.tex")

modelsummary(list("Round 2" = ce1_round2, "Round 2" = ce2_round2, 
                  "Round 2" = ce3_round2, "Round 2" = ce4_round2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             # add_rows = pr2b,
             notes = c("Data weighted by turnout."),
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election",
             output = "output/tab2_models_part2.tex")


modelsummary(list("Round 1" = ce1_round1, "Round 1" = ce2_round1, 
                  "Round 1" = ce3_round1, "Round 1" = ce4_round1, 
                  "Round 2" = ce1_round2, "Round 2" = ce2_round2, 
                  "Round 2" = ce3_round2, "Round 2" = ce4_round2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             # add_rows = pr2,
             notes = c("Data weighted by turnout."),
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election")

```

## Table 3: Turnout and satisfaction with democracy, all panels (without CZ 2023)
```{r}
all_panels_both_waves <- all_panels %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post)) %>% 
    filter(!is.na(female) & !is.na(age) & 
             !is.na(postsecondary_edu) & 
             !is.na(pol_interest_num) & 
             !is.na(party_close)) %>% 
    filter(election != "CZ 2023")

ce1_all <- glm(voted ~ swd_pre + swd_post + election, 
           data = all_panels_both_waves,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_all <- glm(voted ~ swd_pre + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce3_all <- glm(voted ~ swd_post + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_all <- glm(voted ~ swd_pre + swd_post + 
             female + age + postsecondary_edu + 
             pol_interest_num + 
             party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)

fe_rows <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
                   "Election FE", "X", "X", "X", "X")
fe_position <- broom::tidy(ce4_all) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

# attr(fe_rows, "position") <- (fe_position * 2) + 1

# pr2 <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
#                "PseudoR2 (McFadden)", 
#                r2(ce1_all), r2(ce2_all), 
#                r2(ce3_all), r2(ce4_all)) %>% 
#   mutate(across(where(is.numeric), ~as.character(round(.x, 2))))

additional_rows <- bind_rows(
  fe_rows#, pr2
)

attr(additional_rows, "position") <- c(fe_position * 2 + 1, fe_position * 2 + 3)

modelsummary(list(ce1_all, ce2_all, ce3_all, ce4_all), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "swd_pre" = "Pre-election satisfaction",
                 "swd_post" = "Post-election satisfaction", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             coef_omit = "election",
             add_rows = additional_rows,
             output = "output/tab3_models.tex",
             title = "Turnout and satisfaction with democracy, all panels")

modelsummary(list(ce1_all, ce2_all, ce3_all, ce4_all), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "swd_pre" = "Pre-election satisfaction",
                 "swd_post" = "Post-election satisfaction", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             coef_omit = "election",
             add_rows = additional_rows,
             title = "Turnout and satisfaction with democracy, all panels")
```

## Table 4: SWD change, CZ 2023 panel
```{r}
pavel_voters <- cz_2023_all_waves_resp %>% 
  filter(PRES2023CAND2r_w4 == "Petr Pavel") %>% 
  mutate(pavel_decision = case_when(
    IFPRESCAND_1_w1 == "Petr Pavel" & IFPRESCAND_2_w2 == "Petr Pavel" & 
      PRES2023CAND1r_w3 == "Petr Pavel" ~ "V 1. vlně",
    IFPRESCAND_2_w2 == "Petr Pavel" & 
      PRES2023CAND1r_w3 == "Petr Pavel" ~ "V 2. vlně",
    PRES2023CAND1r_w3 == "Petr Pavel" ~ "V 3. vlně", 
    TRUE ~ "V 4. vlně"
  ) %>% factor(., levels = c("V 1. vlně", "V 2. vlně", 
                             "V 3. vlně", "V 4. vlně"))) %>% 
  mutate(
    stable_voter = as.numeric(pavel_decision == "V 1. vlně")
  )

swd1_round1 <- lm(swd_diff ~ voted + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
             data = cz_2023_all_waves_resp, 
             weights = weight_turnout)
swd3_round1 <- lm(swd_diff ~ voter_type + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
                  data = cz_2023_all_waves_resp, 
                  weights = weight_turnout)
swd4_round1 <- lm(swd_diff ~ prez_vote_type + swd_pre + female + age +
                      postsecondary_edu + pol_interest_num + 
                      pol_knowledge + party_close + duty_to_vote, 
                  data = cz_2023_all_waves_resp, 
                  weights = weight_turnout)
swd5_round1 <- lm(swd_diff ~ stable_voter + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
                  data = pavel_voters, 
                  weights = weight_turnout)
swd5_round1_ord <- lm(swd_diff ~ pavel_decision + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
                  data = pavel_voters, 
                  weights = weight_turnout)

modelsummary(list(swd1_round1, swd3_round1, 
                  swd4_round1, swd5_round1
                  ), 
             stars = TRUE, 
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "pol_knowledge" = "Pol. knowledge",
               "party_close" = "Feels close to a party",
               "duty_to_vote" = "Duty to vote", 
               "voter_typeVoted for winner" = "Winner",
               "voter_typeVoted for loser" = "Loser",
               "prez_vote_typefull winner" = "Full winner",
               "prez_vote_typepartial winner" = "Partial winner",
               "prez_vote_typefull loser" = "Full loser",
               "prez_vote_typepartial loser" = "Partial loser",
               "stable_voter" = "Stable winner"
             ), 
             notes = c("Data weighted by turnout."),
             output = "output/tab4_models.tex")

modelsummary(list(swd1_round1, swd3_round1, 
                  swd4_round1, swd5_round1
                  ), 
             stars = TRUE, 
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "pol_knowledge" = "Pol. knowledge",
               "party_close" = "Feels close to a party",
               "duty_to_vote" = "Duty to vote", 
               "voter_typeVoted for winner" = "Winner",
               "voter_typeVoted for loser" = "Loser",
               "prez_vote_typefull winner" = "Full winner",
               "prez_vote_typepartial winner" = "Partial winner",
               "prez_vote_typefull loser" = "Full loser",
               "prez_vote_typepartial loser" = "Partial loser",
               "stable_voter" = "Stable winner"
             ), 
             notes = c("Data weighted by turnout."))
```

```{r}
ggeffect(swd4_round1, "prez_vote_type") %>% 
  plot() + 
  labs(title = "Predicted SWD change by voter type", 
       x = "Voter type", 
       y = "SWD change", 
       caption = "Using model 3 from table above")
```

## Table 5: SWD change, all panels
```{r}
all_panels <- all_panels %>% 
  mutate(age = (age - 18) / 10)

ce1b <- lm(swd_diff ~ voted + swd_pre + female + age + postsecondary_edu + 
             pol_interest_num + party_close + 
             election, data = all_panels, 
           weights = weight_turnout)
ce2b <- lm(swd_diff ~ voter_type + swd_pre + female + age +
             postsecondary_edu + 
             pol_interest_num + party_close + 
             election, data = all_panels, 
           weights = weight_turnout)

fe_rows <- tribble(~term, ~m1, ~m2,  
                   "Country FE", "X", "X")
fe_position <- broom::tidy(ce2b) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(fe_rows, "position") <- 21

modelsummary(list(ce1b, ce2b), 
             stars = TRUE, 
             coef_omit = "election[A-Za-z() ]+\\s[0-9]+$",
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "party_close" = "Feels close to a party",
               "voter_typeVoted for winner" = "Winner", 
               "voter_typeVoted for loser" = "Loser",
               "election_typepresidential" = "Presidential election", 
               "election_typeEP election" = "EP election"
             ),
             add_rows = fe_rows, 
             notes = c("Data weighted by turnout."),
             output = "output/tab5_models.tex")

modelsummary(list(ce1b, ce2b), 
             stars = TRUE, 
             coef_omit = "election[A-Za-z() ]+\\s[0-9]+$",
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "party_close" = "Feels close to a party",
               "voter_typeVoted for winner" = "Winner", 
               "voter_typeVoted for loser" = "Loser",
               "election_typepresidential" = "Presidential election", 
               "election_typeEP election" = "EP election"
             ),
             add_rows = fe_rows,
             notes = c("Data weighted by turnout.")
             # output = "output/tab5_models.tex"
             )
```

## Panel data analysis (waves 1-5)

```{r}
tar_load(cz_2023_long)

long_w1_w5 <- cz_2023_long %>% 
    # filter(wave != 5) %>% 
    mutate(winner_stable2 = case_when(
      winner_stable2 == "sincere winner" ~ "full winner", 
      winner_stable2 == "strategic winner" ~ "partial winner",
      winner_stable2 == "sincere loser" ~ "full loser",
      winner_stable2 == "strategic loser" ~ "partial loser",
      TRUE ~ winner_stable2
    ) %>% factor(., levels = c("abstainer", "full winner", 
                               "partial winner",
                               "full loser", 
                               "partial loser"))) 


```

```{r}
rename_map <- c(
    "winnerwinner" = "winner", 
    "winnerloser" = "loser", 
    "winner_stable2full winner" = "full winner",
    "winner_stable2partial winner" = "partial winner",
    "winner_stable2full loser" = "full loser",
    "winner_stable2partial loser" = "partial loser",
    "vote_gov" = "government voter (PS 2021)"
)

m1_w5 <- lmer(SWD_num ~ winner * wave + (1 | RADIOMETER_ID2), 
              data = long_w1_w5, weights = weight_turnout) 

m2_w5 <- lmer(SWD_num ~ winner_stable2 * wave + (1 | RADIOMETER_ID2), 
              data = long_w1_w5, weights = weight_turnout) 

m3_w5 <- lmer(SWD_num ~ vote_gov * wave + (1 | RADIOMETER_ID2), 
              data = long_w1_w5, weights = weight_turnout) 

modelsummary::modelsummary(list(m1_w5, m2_w5, m3_w5), 
                           stars = TRUE, 
                           coef_rename = rename_map, 
                           notes = c("Data weighted by turnout.")
                           )

```

```{r, eval = FALSE}
(ef1 <- ggeffect(m1_w5, c("wave", "winner")))

plot(ef1) +
    labs(title = "Predicted values of SWD",
         x = "Wave",
         y = "SWD",
         colour = "Voter type")

ggsave("output/swd_change_w1_w5_voter_type.png", 
       width = 7, height = 5)

```

```{r, eval = FALSE}

ggeffect(m2_w5, c("wave", "winner_stable2")) %>% 
    plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")

ggsave("output/swd_change_w1_w5_voter_type5.png", 
       width = 7, height = 5)
```

```{r, eval = FALSE}
ggeffect(m3_w5, c("wave", "vote_gov")) %>% 
    plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type", 
         caption = "Voter type: 1 = voted for parties that formed government after the 2021 parliamentary election")
ggsave("output/swd_change_w1_w5_gov_voter.png", 
       width = 7, height = 5)

```

## Robustness checks

### Czech 2023 panel, pre-election SWD measured in Wave 2
Same models as in Table 2, but instead of pre-election SWD measured in Wave 1, pre-election SWD in Wave 2 is used
```{r}
ce1_round1_r <- glm(voted_1r ~ SWD_w2 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_round1_r <- glm(voted_1r ~ SWD_w2 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_round1_r <- glm(voted_1r ~ SWD_w2 + SWD_w4 + 
             female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)

ce1_round2_r <- glm(voted_2r ~ SWD_w2 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_round2_r <- glm(voted_2r ~ SWD_w2 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_round2_r <- glm(voted_2r ~ SWD_w2 + SWD_w4 + 
             female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)

# pr2_r <- tribble(~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6,
#                "PseudoR2 (McFadden)", 
#                r2(ce1_round1_r), r2(ce2_round1_r), 
#                r2(ce4_round1_r), 
#                r2(ce1_round2_r), r2(ce2_round2_r), 
#                r2(ce4_round2_r)
#                )

# model_n_vars <- broom::tidy(ce4_round1_r) %>% 
#     filter(!grepl("election", term)) %>% 
#     nrow()

# attr(pr2_r, "position") <- (model_n_vars * 2) + 2

modelsummary(list("Round 1" = ce1_round1_r, 
                  "Round 1" = ce2_round1_r, 
                  "Round 1" = ce4_round1_r,
                  "Round 2" = ce1_round2_r, 
                  "Round 2" = ce2_round2_r, 
                  "Round 2" = ce4_round2_r), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w2" = "Pre-election satisfaction (Wave 2)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             # add_rows = pr2_r,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election")



```
### Czech 2023 panel, pre-election SWD measured in Wave 3
```{r}
ce1_round2_r2 <- glm(voted_2r ~ SWD_w3 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_round2_r2 <- glm(voted_2r ~ SWD_w3 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_round2_r2 <- glm(voted_2r ~ SWD_w3 + SWD_w4 + 
             female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)


# pr2_r2 <- tribble(~term, ~m1, ~m2, ~m3, 
#                "PseudoR2 (McFadden)", 
#                r2(ce1_round2_r2), r2(ce2_round2_r2), 
#                r2(ce4_round2_r2)
#                )
# 
# model_n_vars_r2 <- broom::tidy(ce4_round2_r2) %>% 
#     filter(!grepl("election", term)) %>% 
#     nrow()
# 
# attr(pr2_r2, "position") <- (model_n_vars_r2 * 2) + 2

modelsummary(list("Round 2" = ce1_round2_r2, 
                  "Round 2" = ce2_round2_r2, 
                  "Round 2" = ce4_round2_r2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w3" = "Pre-election satisfaction (Wave 3, before Round 2)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             # add_rows = pr2_r2,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election")

```

### Turnout and satisfaction with democracy, all panels
```{r}
all_panels_both_waves <- all_panels %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post)) %>% 
    filter(!is.na(female) & !is.na(age) & 
             !is.na(postsecondary_edu) & 
             !is.na(pol_interest_num) & 
             !is.na(party_close)) 

ce1_all_b <- glm(voted ~ swd_pre + swd_post + election, 
           data = all_panels_both_waves,
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce2_all_b <- glm(voted ~ swd_pre + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce3_all_b <- glm(voted ~ swd_post + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)
ce4_all_b <- glm(voted ~ swd_pre + swd_post + 
             female + age + postsecondary_edu + 
             pol_interest_num + 
             party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"), 
           weights = weight_turnout)

fe_rows <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
                   "Election FE", "X", "X", "X", "X")
fe_position <- broom::tidy(ce4_all_b) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

# attr(fe_rows, "position") <- (fe_position * 2) + 1

# pr2_b <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
#                "PseudoR2 (McFadden)", 
#                r2(ce1_all_b), r2(ce2_all_b), 
#                r2(ce3_all_b), r2(ce4_all_b)) %>% 
#   mutate(across(where(is.numeric), ~as.character(round(.x, 2))))

additional_rows <- bind_rows(
  fe_rows# , pr2_b
)

attr(additional_rows, "position") <- c(fe_position * 2 + 1, fe_position * 2 + 3)

modelsummary(list(ce1_all_b, ce2_all_b, ce3_all_b, ce4_all_b), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "swd_pre" = "Pre-election satisfaction",
                 "swd_post" = "Post-election satisfaction", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             coef_omit = "election",
             add_rows = additional_rows,
             title = "Turnout and satisfaction with democracy, all panels")
```

