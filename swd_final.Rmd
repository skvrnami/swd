---
title: "Satisfaction with democracy"
author: "Michael Škvrňák"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: readable
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(lme4)
library(dplyr)
library(sjPlot)
library(targets)
library(ggplot2)
library(modelsummary)

options("modelsummary_format_numeric_latex" = "plain")

tar_load(cz_2023_models)
tar_load(all_panels)
```


## Table 1: Descriptive stats of SWD
```{r, message=FALSE}
cz_2023 <- cz_2023_models

avg_swd_cz2023 <- cz_2023 %>% 
    filter(w1 == 1 & w2 == 1 & w3 == 1 & w4 == 1) %>% 
    mutate(across(matches("SWD_w[0-9]+"), function(x) x / 10)) %>% 
    summarise(across(matches("SWD_w[0-9]+"), ~round(mean(.x), 2)))

avg_swd_cz2023 %>% 
    knitr::kable(., format = "latex") %>% 
    writeLines(., "output/avg_swd_cz2023_panel.tex")

avg_swd_cz2023 %>% 
    knitr::kable()

avg_swd_all_panels <- all_panels %>% 
    group_by(election, election_type) %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post)) %>% 
    summarise(across(matches("swd_p"), ~round(mean(.x), 2)), 
              .groups = "drop", 
              n = n()) %>% 
    mutate(country = case_when(
        grepl("CZ", election) ~ "Czech Republic", 
        grepl("DE", election) ~ "Germany (East)",
        grepl("PL", election) ~ "Poland", 
        grepl("HU", election) ~ "Hungary", 
        grepl("RO", election) ~ "Romania",
    ), 
        year = stringr::str_extract(election, "[0-9]{4}")
    ) %>% 
    select(country, year, election_type, matches("swd_p"), n) %>% 
    mutate(swd_diff = swd_post - swd_pre) %>% 
    select(country, year, election_type, swd_pre, swd_post, swd_diff, n)

avg_swd_all_panels %>% 
    knitr::kable(., format = "latex") %>% 
    writeLines(., "output/avg_swd_all_panels.tex")

avg_swd_all_panels %>% 
    knitr::kable()
```

## Table 2: Turnout and satisfaction with democracy, 2023 Czech presidential election
```{r}
cz_2023_all_waves_resp <- cz_2023 %>% 
    filter(w1 == 1 & w2 == 1 & w3 == 1 & w4 == 1) %>% 
    mutate(age = (age - 18) / 10) %>% 
    rename(pol_knowledge = pol_knowledge_pct) %>% 
    mutate(prez_vote_type = case_when(
      PRES2023CAND1r_w3 == "nevolič" & 
        PRES2023CAND2r_w4 == "nevolič" ~ "abstainer",
      PRES2023CAND1r_w3 == "Petr Pavel" & 
        PRES2023CAND2r_w4 == "Petr Pavel" ~ "full winner",
      PRES2023CAND1r_w3 == "Andrej Babiš" & 
        PRES2023CAND2r_w4 == "Andrej Babiš" ~ "full loser",
      PRES2023CAND2r_w4 == "Petr Pavel" ~ "partial winner",
      PRES2023CAND2r_w4 == "Andrej Babiš" ~ "partial loser",
      TRUE ~ "abstainer"
    )) %>% 
    mutate(prez_vote_type = factor(
      prez_vote_type, 
      levels = c("abstainer", 
                 "full winner", 
                 "partial winner", 
                 "full loser", 
                 "partial loser")))

# haven::write_sav(cz_2023_all_waves_resp, "tmp/cz_2023_vsechny_vlny.sav")

ce1_round1 <- glm(voted_1r ~ SWD_w1 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"))
ce2_round1 <- glm(voted_1r ~ SWD_w1 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce3_round1 <- glm(voted_1r ~ SWD_w4 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce4_round1 <- glm(voted_1r ~ SWD_w1 + SWD_w4 + 
             female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))

ce1_round2 <- glm(voted_2r ~ SWD_w1 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"))
ce2_round2 <- glm(voted_2r ~ SWD_w1 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce3_round2 <- glm(voted_2r ~ SWD_w4 + female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce4_round2 <- glm(voted_2r ~ SWD_w1 + SWD_w4 + 
             female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))

r2 <- function(x){
  pscl::pR2(x)["McFadden"]
}

pr2 <- tribble(~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6, ~m7, ~m8, 
               "PseudoR2 (McFadden)", 
               r2(ce1_round1), r2(ce2_round1), 
               r2(ce3_round1), r2(ce4_round1), 
               r2(ce1_round2), r2(ce2_round2), 
               r2(ce3_round2), r2(ce4_round2))

model_n_vars <- broom::tidy(ce4_round1) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(pr2, "position") <- (model_n_vars * 2) + 2

pr2a <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
               "PseudoR2 (McFadden)", 
               r2(ce1_round1), r2(ce2_round1), 
               r2(ce3_round1), r2(ce4_round1))

model_n_vars <- broom::tidy(ce4_round1) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(pr2a, "position") <- (model_n_vars * 2) + 2

pr2b <- tribble(~term, ~m5, ~m6, ~m7, ~m8, 
               "PseudoR2 (McFadden)", 
               r2(ce1_round2), r2(ce2_round2), 
               r2(ce3_round2), r2(ce4_round2))

model_n_vars <- broom::tidy(ce4_round1) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(pr2b, "position") <- (model_n_vars * 2) + 2


modelsummary(list("Round 1" = ce1_round1, "Round 1" = ce2_round1, 
                  "Round 1" = ce3_round1, "Round 1" = ce4_round1, 
                  "Round 2" = ce1_round2, "Round 2" = ce2_round2, 
                  "Round 2" = ce3_round2, "Round 2" = ce4_round2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             add_rows = pr2,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election",
             output = "output/tab1_models.tex")

modelsummary(list("Round 1" = ce1_round1, "Round 1" = ce2_round1, 
                  "Round 1" = ce3_round1, "Round 1" = ce4_round1), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             add_rows = pr2a,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election",
             output = "output/tab1_models_part1.tex")

modelsummary(list("Round 2" = ce1_round2, "Round 2" = ce2_round2, 
                  "Round 2" = ce3_round2, "Round 2" = ce4_round2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             add_rows = pr2b,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election",
             output = "output/tab1_models_part2.tex")


modelsummary(list("Round 1" = ce1_round1, "Round 1" = ce2_round1, 
                  "Round 1" = ce3_round1, "Round 1" = ce4_round1, 
                  "Round 2" = ce1_round2, "Round 2" = ce2_round2, 
                  "Round 2" = ce3_round2, "Round 2" = ce4_round2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w1" = "Pre-election satisfaction (Wave 1)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             add_rows = pr2,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election")

```

## Table 3: Turnout and satisfaction with democracy, all panels (without CZ 2023)
```{r}
all_panels_both_waves <- all_panels %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post)) %>% 
    filter(!is.na(female) & !is.na(age) & 
             !is.na(postsecondary_edu) & 
             !is.na(pol_interest_num) & 
             !is.na(party_close)) %>% 
    filter(election != "CZ 2023")

ce1_all <- glm(voted ~ swd_pre + swd_post + election, 
           data = all_panels_both_waves,
           family = binomial(link = "logit"))
ce2_all <- glm(voted ~ swd_pre + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"))
ce3_all <- glm(voted ~ swd_post + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"))
ce4_all <- glm(voted ~ swd_pre + swd_post + 
             female + age + postsecondary_edu + 
             pol_interest_num + 
             party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"))

fe_rows <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
                   "Election FE", "X", "X", "X", "X")
fe_position <- broom::tidy(ce4_all) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

# attr(fe_rows, "position") <- (fe_position * 2) + 1

pr2 <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
               "PseudoR2 (McFadden)", 
               r2(ce1_all), r2(ce2_all), 
               r2(ce3_all), r2(ce4_all)) %>% 
  mutate(across(where(is.numeric), ~as.character(round(.x, 2))))

additional_rows <- bind_rows(
  fe_rows, pr2
)

attr(additional_rows, "position") <- c(fe_position * 2 + 1, fe_position * 2 + 3)

modelsummary(list(ce1_all, ce2_all, ce3_all, ce4_all), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "swd_pre" = "Pre-election satisfaction",
                 "swd_post" = "Post-election satisfaction", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             coef_omit = "election",
             add_rows = additional_rows,
             output = "output/tab3_models.tex",
             title = "Turnout and satisfaction with democracy, all panels")

modelsummary(list(ce1_all, ce2_all, ce3_all, ce4_all), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "swd_pre" = "Pre-election satisfaction",
                 "swd_post" = "Post-election satisfaction", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             coef_omit = "election",
             add_rows = additional_rows,
             title = "Turnout and satisfaction with democracy, all panels")
```

## Table 4: SWD change, CZ 2023 panel
```{r}
swd1_round1 <- lm(swd_diff ~ voted + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
             data = cz_2023_all_waves_resp)
swd3_round1 <- lm(swd_diff ~ voter_type + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
                  data = cz_2023_all_waves_resp)
swd4_round1 <- lm(swd_diff ~ prez_vote_type + swd_pre + female + age +
                      postsecondary_edu + pol_interest_num + 
                      pol_knowledge + party_close + duty_to_vote, 
                  data = cz_2023_all_waves_resp)
swd5_round1 <- lm(swd_diff ~ stable_voter + swd_pre + female + age +
                    postsecondary_edu + pol_interest_num + 
                    pol_knowledge + party_close + duty_to_vote, 
                  data = cz_2023_all_waves_resp)

modelsummary(list(swd1_round1, swd3_round1, 
                  swd4_round1, swd5_round1), 
             stars = TRUE, 
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "pol_knowledge" = "Pol. knowledge",
               "party_close" = "Feels close to a party",
               "duty_to_vote" = "Duty to vote", 
               "voter_typeAbstainer" = "Abstainer",
               "voter_typeVoted for winner" = "Voted for winner",
               "prez_vote_typefull winner" = "Full winner",
               "prez_vote_typepartial winner" = "Partial winner",
               "prez_vote_typefull loser" = "Full loser",
               "prez_vote_typepartial loser" = "Partial loser",
               "stable_voter" = "Stable voter"
             ), 
             output = "output/tab4_models.tex")

modelsummary(list(swd1_round1, swd3_round1, 
                  swd4_round1, swd5_round1), 
             stars = TRUE, 
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "pol_knowledge" = "Pol. knowledge",
               "party_close" = "Feels close to a party",
               "duty_to_vote" = "Duty to vote", 
               "voter_typeAbstainer" = "Abstainer",
               "voter_typeVoted for winner" = "Voted for winner",
               "prez_vote_typefull winner" = "Full winner",
               "prez_vote_typepartial winner" = "Partial winner",
               "prez_vote_typefull loser" = "Full loser",
               "prez_vote_typepartial loser" = "Partial loser",
               "stable_voter" = "Stable voter"
             ))
```

```{r}
ggeffects::ggeffect(swd4_round1, "prez_vote_type") %>% 
  plot() + 
  labs(title = "Predicted SWD change by voter type", 
       x = "Voter type", 
       y = "SWD change", 
       caption = "Using model 3 from table above")
```

## Table 5: SWD change, all panels
```{r}
all_panels <- all_panels %>% 
  mutate(age = (age - 18) / 10)

ce1b <- lm(swd_diff ~ voted + swd_pre + female + age + postsecondary_edu + 
             pol_interest_num + party_close + 
             election, data = all_panels)
ce2b <- lm(swd_diff ~ voter_type + swd_pre + female + age +
             postsecondary_edu + 
             pol_interest_num + party_close + 
             election, data = all_panels)
ce3b <- lm(swd_diff ~ voted + election_type + swd_pre + female + age +
             postsecondary_edu + 
             pol_interest_num + party_close, data = all_panels)
ce4b <- lm(swd_diff ~ voted * election_type + swd_pre + female + age +
             postsecondary_edu + 
             pol_interest_num + party_close, data = all_panels)
ce5b <- lm(swd_diff ~ voter_type * election_type + swd_pre + female + age +
             postsecondary_edu + 
             pol_interest_num + party_close + 
             election, data = all_panels)

fe_rows <- tribble(~term, ~m1, ~m2, ~m3, ~m4, ~m5, 
                   "Country FE", "X", "X", "", "", "")
fe_position <- broom::tidy(ce5b) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(fe_rows, "position") <- 21 + 16

modelsummary(list(ce1b, ce2b, ce3b, ce4b, ce5b), 
             stars = TRUE, 
             coef_omit = "election[A-Za-z() ]+\\s[0-9]+$",
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "party_close" = "Feels close to a party",
               "voter_typeAbstainer" = "Abstainer",
               "voter_typeVoted for winner" = "Voted for winner", 
               "election_typepresidential" = "Presidential election", 
               "election_typeEP election" = "EP election"
             ),
             add_rows = fe_rows, 
             output = "output/tab5_models.tex")

modelsummary(list(ce1b, ce2b, ce3b, ce4b, ce5b), 
             stars = TRUE, 
             coef_omit = "election[A-Za-z() ]+\\s[0-9]+$",
             coef_rename = c(
               "voted" = "Turned out",
               "swd_pre" = "Pre-election SWD",
               "female" = "Female",
               "age" = "Age (decades)",
               "postsecondary_edu" = "Post-secondary education",
               "pol_interest_num" = "Pol. interest", 
               "party_close" = "Feels close to a party",
               "voter_typeAbstainer" = "Abstainer",
               "voter_typeVoted for winner" = "Voted for winner", 
               "election_typepresidential" = "Presidential election", 
               "election_typeEP election" = "EP election"
             ),
             add_rows = fe_rows # , 
             # output = "output/tab5_models.tex"
             )
```

## Panel data analysis (waves 1-4)

```{r}
tar_load(cz_2023_long)

# long_w1_w5 <- cz_2023_long
long_w1_w4 <- cz_2023_long %>% 
    filter(wave != 5) %>% 
    mutate(winner_stable2 = case_when(
      winner_stable2 == "sincere winner" ~ "full winner", 
      winner_stable2 == "strategic winner" ~ "partial winner",
      winner_stable2 == "sincere loser" ~ "full loser",
      winner_stable2 == "strategic loser" ~ "partial loser",
      TRUE ~ winner_stable2
    ) %>% factor(., levels = c("abstainer", "full winner", 
                               "partial winner",
                               "full loser", 
                               "partial loser"))) 


```

```{r}
rename_map <- c(
    "winnerwinner" = "winner", 
    "winnerloser" = "loser", 
    "winner_stable2full winner" = "full winner",
    "winner_stable2partial winner" = "partial winner",
    "winner_stable2full loser" = "full loser",
    "winner_stable2partial loser" = "partial loser",
    "vote_gov" = "government voter (PS 2021)"
)

m1_w4 <- lmer(SWD_num ~ winner * wave + (1 | RADIOMETER_ID2), 
     data = long_w1_w4) 

m2_w4 <- lmer(SWD_num ~ winner_stable2 * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w4) 

m3_w4 <- lmer(SWD_num ~ vote_gov * wave + (1 | RADIOMETER_ID2), 
           data = long_w1_w4) 

modelsummary::modelsummary(list(m1_w4, m2_w4, m3_w4), 
                           stars = TRUE, 
                           coef_rename = rename_map
                           )

ggeffects::ggeffect(m1_w4, c("wave", "winner")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")
ggeffects::ggeffect(m2_w4, c("wave", "winner_stable2")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type")

ggeffects::ggeffect(m3_w4, c("wave", "vote_gov")) %>% plot() + 
    labs(title = "Predicted values of SWD", 
         x = "Wave", 
         y = "SWD", 
         colour = "Voter type", 
         caption = "Voter type: 1 = voted for parties that formed government after the 2021 parliamentary election")
```


## Robustness checks

### Czech 2023 panel, pre-election SWD measured in Wave 2
Same models as in Table 2, but instead of pre-election SWD measured in Wave 1, pre-election SWD in Wave 2 is used
```{r}
ce1_round1_r <- glm(voted_1r ~ SWD_w2 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"))
ce2_round1_r <- glm(voted_1r ~ SWD_w2 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce4_round1_r <- glm(voted_1r ~ SWD_w2 + SWD_w4 + 
             female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))

ce1_round2_r <- glm(voted_2r ~ SWD_w2 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"))
ce2_round2_r <- glm(voted_2r ~ SWD_w2 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce4_round2_r <- glm(voted_2r ~ SWD_w2 + SWD_w4 + 
             female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))


pr2_r <- tribble(~term, ~m1, ~m2, ~m3, ~m4, ~m5, ~m6,
               "PseudoR2 (McFadden)", 
               r2(ce1_round1_r), r2(ce2_round1_r), 
               r2(ce4_round1_r), 
               r2(ce1_round2_r), r2(ce2_round2_r), 
               r2(ce4_round2_r)
               )

model_n_vars <- broom::tidy(ce4_round1_r) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(pr2_r, "position") <- (model_n_vars * 2) + 2

modelsummary(list("Round 1" = ce1_round1_r, 
                  "Round 1" = ce2_round1_r, 
                  "Round 1" = ce4_round1_r,
                  "Round 2" = ce1_round2_r, 
                  "Round 2" = ce2_round2_r, 
                  "Round 2" = ce4_round2_r), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w2" = "Pre-election satisfaction (Wave 2)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             add_rows = pr2_r,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election")



```
### Czech 2023 panel, pre-election SWD measured in Wave 3
```{r}
ce1_round2_r2 <- glm(voted_2r ~ SWD_w3 + SWD_w4, 
           data = cz_2023_all_waves_resp,
           family = binomial(link = "logit"))
ce2_round2_r2 <- glm(voted_2r ~ SWD_w3 + female + age + postsecondary_edu + duty_to_vote + 
             pol_interest_num + pol_knowledge + party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))
ce4_round2_r2 <- glm(voted_2r ~ SWD_w3 + SWD_w4 + 
             female + age + postsecondary_edu + 
             duty_to_vote + pol_interest_num + pol_knowledge + 
             party_close, 
           data = cz_2023_all_waves_resp, 
           family = binomial(link = "logit"))


pr2_r2 <- tribble(~term, ~m1, ~m2, ~m3, 
               "PseudoR2 (McFadden)", 
               r2(ce1_round2_r2), r2(ce2_round2_r2), 
               r2(ce4_round2_r2)
               )

model_n_vars_r2 <- broom::tidy(ce4_round2_r2) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

attr(pr2_r2, "position") <- (model_n_vars_r2 * 2) + 2

modelsummary(list("Round 2" = ce1_round2_r2, 
                  "Round 2" = ce2_round2_r2, 
                  "Round 2" = ce4_round2_r2), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "SWD_w3" = "Pre-election satisfaction (Wave 3, before Round 2)",
                 "SWD_w4" = "Post-election satisfaction (Wave 4)", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             add_rows = pr2_r2,
             title = "Turnout and satisfaction with democracy, 2023 Czech presidential election")

```

### Turnout and satisfaction with democracy, all panels
```{r}
all_panels_both_waves <- all_panels %>% 
    filter(!is.na(swd_pre) & !is.na(swd_post)) %>% 
    filter(!is.na(female) & !is.na(age) & 
             !is.na(postsecondary_edu) & 
             !is.na(pol_interest_num) & 
             !is.na(party_close)) 

ce1_all_b <- glm(voted ~ swd_pre + swd_post + election, 
           data = all_panels_both_waves,
           family = binomial(link = "logit"))
ce2_all_b <- glm(voted ~ swd_pre + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"))
ce3_all_b <- glm(voted ~ swd_post + female + age + postsecondary_edu + 
             pol_interest_num + party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"))
ce4_all_b <- glm(voted ~ swd_pre + swd_post + 
             female + age + postsecondary_edu + 
             pol_interest_num + 
             party_close + election, 
           data = all_panels_both_waves, 
           family = binomial(link = "logit"))

fe_rows <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
                   "Election FE", "X", "X", "X", "X")
fe_position <- broom::tidy(ce4_all_b) %>% 
    filter(!grepl("election", term)) %>% 
    nrow()

# attr(fe_rows, "position") <- (fe_position * 2) + 1

pr2_b <- tribble(~term, ~m1, ~m2, ~m3, ~m4, 
               "PseudoR2 (McFadden)", 
               r2(ce1_all_b), r2(ce2_all_b), 
               r2(ce3_all_b), r2(ce4_all_b)) %>% 
  mutate(across(where(is.numeric), ~as.character(round(.x, 2))))

additional_rows <- bind_rows(
  fe_rows, pr2_b
)

attr(additional_rows, "position") <- c(fe_position * 2 + 1, fe_position * 2 + 3)

modelsummary(list(ce1_all_b, ce2_all_b, ce3_all_b, ce4_all_b), 
             stars = TRUE, fmt = 2, coef_rename = c(
                 "swd_pre" = "Pre-election satisfaction",
                 "swd_post" = "Post-election satisfaction", 
                 "female" = "Female",
                 "age" = "Age (decades)", 
                 "postsecondary_edu" = "Post-secondary education", 
                 "duty_to_vote" = "Duty to vote", 
                 "pol_interest_num" = "Interest in politics",
                 "pol_knowledge" = "Political knowledge", 
                 "party_close" = "Feels close to a party"
             ), 
             coef_omit = "election",
             add_rows = additional_rows,
             title = "Turnout and satisfaction with democracy, all panels")
```

